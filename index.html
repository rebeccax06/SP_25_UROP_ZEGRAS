<!DOCTYPE html>
<html>
  <head>
    <title>Interactive Mapping: Bicycle Accessibility</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Leaflet & GeoRaster JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
    <!-- Your CSS -->
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <div id="map"></div>
    <div class="sidebar">
      <h3>Bicycle Accessibility</h3>
      <br />

      <label for="areaSelector">Select Area:</label>
      <select id="areaSelector">
        <option value="boston">Boston (urban)</option>
        <option value="mattapan">Mattapan Food and Fitness</option>
        <option value="southwest_corridor">Southwest Corridor</option>
        <option value="roxburycc">Roxbury Community College</option>
      </select>

      <hr />

      <strong>Show Isochrones:</strong><br />
      <div class="isochrone-controls">

        <!-- 10 min block -->
        <div class="iso-block">
          <label>
            <input type="checkbox" class="iso-checkbox" data-minutes="10" />
            <span class="color-indicator" style="background-color:#bdd7e7;"></span>
            10 min
          </label><br/>
          <div class="lts-minute-controls" data-minutes="10">
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="10" data-lts="1" />
              <span class="line-indicator lts1"></span> LTS 1
            </label>
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="10" data-lts="2" />
              <span class="line-indicator lts2"></span> LTS 2
            </label>
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="10" data-lts="3" />
              <span class="line-indicator lts3"></span> LTS 3
            </label>
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="10" data-lts="4" />
              <span class="line-indicator lts4"></span> LTS 4
            </label>
          </div>
        </div>

        <!-- 20 min block -->
        <div class="iso-block">
          <label>
            <input type="checkbox" class="iso-checkbox" data-minutes="20" checked />
            <span class="color-indicator" style="background-color:#fee6ce;"></span>
            20 min
          </label><br/>
          <div class="lts-minute-controls" data-minutes="20">
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="20" data-lts="1" />
              <span class="line-indicator lts1"></span> LTS 1
            </label>
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="20" data-lts="2" />
              <span class="line-indicator lts2"></span> LTS 2
            </label>
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="20" data-lts="3" />
              <span class="line-indicator lts3"></span> LTS 3
            </label>
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="20" data-lts="4" />
              <span class="line-indicator lts4"></span> LTS 4
            </label>
          </div>
        </div>

        <!-- 30 min block -->
        <div class="iso-block">
          <label>
            <input type="checkbox" class="iso-checkbox" data-minutes="30" />
            <span class="color-indicator" style="background-color:#c7e9c0;"></span>
            30 min
          </label><br/>
          <div class="lts-minute-controls" data-minutes="30">
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="30" data-lts="1" />
              <span class="line-indicator lts1"></span> LTS 1
            </label>
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="30" data-lts="2" />
              <span class="line-indicator lts2"></span> LTS 2
            </label>
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="30" data-lts="3" />
              <span class="line-indicator lts3"></span> LTS 3
            </label>
            <label>
              <input type="checkbox" class="lts-minute-checkbox" data-minutes="30" data-lts="4" />
              <span class="line-indicator lts4"></span> LTS 4
            </label>
          </div>
        </div>

      </div>

      <hr />

      <button id="loadArea">Load Area</button>
      <div id="loading" class="loading">Loading data...</div>
      <div id="errorMessage" class="error-message"></div>
      <div id="currentFile" style="font-size:0.8em; margin-top:10px; word-break:break-all;"></div>
    </div>

    <script>
      // 1) Map setup
      var map = L.map("map").setView([42.3601, -71.0589], 13);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      // 2) Styles
      var isoStyles = {
        10: { color:"#08519c", fillColor:"#bdd7e7", weight:2, fillOpacity:0.5 },
        20: { color:"#d94801", fillColor:"#fee6ce", weight:2, fillOpacity:0.5 },
        30: { color:"#238b45", fillColor:"#c7e9c0", weight:2, fillOpacity:0.5 }
      };
      var ltsStyles = {
        1: { color:"#1b9e77", weight:3, dashArray:null    },
        2: { color:"#d95f02", weight:3, dashArray:"6,4"   },
        3: { color:"#7570b3", weight:3, dashArray:"1,5"   },
        4: { color:"#e7298a", weight:3, dashArray:"10,4,2,4" }
      };

      // 3) Layer management
      var activeLayers = [];
      function clearLayers() {
        activeLayers.forEach(l => map.removeLayer(l));
        activeLayers = [];
      }
      function fetchAndAdd(url, style) {
        return fetch(url)
          .then(r => { if(!r.ok) throw new Error(r.statusText); return r.json(); })
          .then(json => {
            var layer = L.geoJSON(json, { style: style }).addTo(map);
            activeLayers.push(layer);
            if(activeLayers.length===1) map.fitBounds(layer.getBounds());
          })
          .catch(err => console.error("Load error",url,err));
      }

      // 4) Show/hide per-minute LTS pickers
      document.querySelectorAll('.iso-checkbox').forEach(cb => {
        function togglePicker() {
          var m = cb.dataset.minutes;
          var picker = document.querySelector(`.lts-minute-controls[data-minutes="${m}"]`);
          picker.style.display = cb.checked ? 'block' : 'none';
          if(!cb.checked) picker.querySelectorAll('input').forEach(c => c.checked=false);
        }
        cb.addEventListener('change', togglePicker);
        togglePicker();
      });

      // 5) Main loader
      document.getElementById('loadArea').addEventListener('click', () => {
        clearLayers();
        var area   = document.getElementById('areaSelector').value;
        var prefix = area; 

        // selected minutes
        var mins = Array.from(document.querySelectorAll('.iso-checkbox:checked'))
                      .map(cb=>cb.dataset.minutes);

        mins.forEach(minutes => {
          // 5a) base isochrone
        
          var isoFile = `./data/${prefix}_at_${minutes}_minutes_lts1.json`;
          fetchAndAdd(isoFile, isoStyles[minutes]);
          
          // 5b) its own LTS overlays
          var ltsFor = Array.from(
            document.querySelectorAll(`.lts-minute-checkbox[data-minutes="${minutes}"]:checked`)
          ).map(cb=>cb.dataset.lts);

          ltsFor.forEach(lts => {
            var ltsFile = `./data/${prefix}_at_${minutes}_minutes_lts${lts}.json`;
            fetchAndAdd(ltsFile, () => ltsStyles[lts]);
          });
        });
      });

      // 6) Autoâ€load on start
      window.addEventListener('load', () => document.getElementById('loadArea').click());
    </script>
  </body>
</html>
